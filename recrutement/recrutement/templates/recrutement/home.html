<!DOCTYPE html>
{% load static %}
<html lang="fr">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TalentMatch - Accueil</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link href="{% static 'css/style.css' %}" rel="stylesheet" />
</head>
<body>
    <div class="floating-elements">
        <div class="floating-circle"></div>
        <div class="floating-circle"></div>
        <div class="floating-circle"></div>
    </div>

    <nav class="navbar">
        <div class="container-fluid">
            <div class="navbar-brand">
                <i class="fas fa-brain"></i>
                <span>TalentMatch</span>
            </div>
            <div class="d-flex align-items-center gap-3">
                <a href="{% url 'home' %}" class="nav-link-header"><i class="fas fa-home"></i> Accueil</a>
                <a href="{% url 'home' %}" class="nav-link-header"><i class="fas fa-briefcase"></i> Offres</a>
                <a href="{% url 'profil' %}" class="nav-link-header"><i class="fas fa-user"></i> Profil</a>
                
                <!-- Formulaire de déconnexion caché -->
                <a href="#" class="logout-btn" onclick="event.preventDefault(); document.getElementById('logoutForm').submit();">
                    <i class="fas fa-sign-out-alt"></i>
                    Déconnexion
                </a>
                <form method="post" action="{% url 'logout' %}" id="logoutForm" style="display: none;">
                    {% csrf_token %}
                </form>
            </div>
        </div>
    </nav>

    <div class="container">
        <div class="welcome-banner">
            <div class="welcome-text">
                <i class="fas fa-rocket"></i>
                Bonjour {{ user.get_full_name|default:user.username }} ! Découvrez <strong>{{ offres|length }}</strong> opportunités qui correspondent à votre profil
            </div>
        </div>

        <!-- Section de recherche avancée -->
        <div class="search-section-home">
            <div class="search-box-container">
                <div class="search-input-group">
                    <i class="fas fa-search search-icon-home"></i>
                    <input type="text" class="search-input-home" placeholder="Poste, compétences, mots-clés..." id="searchJob">
                </div>
                <div class="location-input-group">
                    <i class="fas fa-map-marker-alt location-icon-home"></i>
                    <input type="text" class="location-input-home" placeholder="Dakar, Sénégal" value="Dakar" id="searchLocation">
                </div>
                <button class="search-btn-home">
                    <i class="fas fa-search"></i>
                    Rechercher
                </button>
            </div>
            
            <div class="filters-container">
                <button class="filter-chip active" data-filter="all">
                    <i class="fas fa-star"></i> Toutes les offres
                </button>
                <button class="filter-chip" data-filter="CDI">
                    <i class="fas fa-briefcase"></i> CDI
                </button>
                <button class="filter-chip" data-filter="CDD">
                    <i class="fas fa-clock"></i> CDD
                </button>
                <button class="filter-chip" data-filter="Stage">
                    <i class="fas fa-graduation-cap"></i> Stage
                </button>
                <button class="filter-chip" data-filter="urgent">
                    <i class="fas fa-bolt"></i> Urgent
                </button>
            </div>
        </div>

        <!-- Barre de statistiques -->
        <div class="stats-bar">
            <div class="stat-item">
                <span class="statnumber">{{ offres|length }}</span>
                <span class="statlabel">Offres actives</span>
            </div>
            <div class="stat-item">
                <span class="statnumber">5</span>
                <span class="statlabel">Entreprises</span>
            </div>
            <div class="stat-item">
                <span class="statnumber">7</span>
                <span class="statlabel">CV analysés</span>
            </div>
            <div class="stat-item">
                <span class="statnumber">86%</span>
                <span class="statlabel">Taux de matching</span>
            </div>
        </div>

        <div class="section-header-home">
            <h1 class="section-title">
                <i class="fas fa-fire"></i> Offres recommandées pour vous
            </h1>
            <a href="#" class="view-all-btn">
                Voir toutes les offres
                <i class="fas fa-arrow-right"></i>
            </a>
        </div>

        {% if offres %}
        <div class="jobs-grid">
            {% for offre in offres %}
            <div class="job-card" data-type="{{ offre.type_contrat }}">
                <!-- En-tête de la carte avec logo entreprise -->
                <div class="job-card-header">
                    <div class="company-info-section">
                        {% if offre.logo %}
                        <img src="{{ offre.logo.url }}" alt="{{ offre.entreprise }}" class="company-logo-img">
                        {% else %}
                        <div class="company-logo-placeholder">
                            <i class="fas fa-building"></i>
                        </div>
                        {% endif %}
                        
                        <div class="company-details-info">
                            <h3 class="company-name">{{ offre.entreprise }}</h3>
                            <div class="job-location">
                                <i class="fas fa-map-marker-alt"></i>
                                {{ offre.localisation }}
                            </div>
                        </div>
                    </div>
                    
                    <div class="job-badges-container">
                        {% if offre.nouveau %}
                        <span class="job-badge badge-new">Nouveau</span>
                        {% endif %}
                        {% if offre.urgent %}
                        <span class="job-badge badge-urgent">Urgent</span>
                        {% endif %}
                    </div>
                </div>

                <!-- Titre de l'offre -->
                <a href="#" class="job-title" data-bs-toggle="modal" data-bs-target="#detailsModal{{ offre.id }}">
                    <i class="fas fa-briefcase"></i>
                    {{ offre.titre }}
                </a>

                <!-- Tags d'informations -->
                <div class="job-info-tags">
                    <span class="info-tag">
                        <i class="fas fa-briefcase"></i> {{ offre.type_contrat }}
                    </span>
                    {% if offre.salaire_min and offre.salaire_max %}
                    <span class="info-tag">
                        <i class="fas fa-money-bill-wave"></i> 
                        {{ offre.get_salaire_display }}
                    </span>
                    {% endif %}
                    {% if offre.temps_plein %}
                    <span class="info-tag">
                        <i class="fas fa-clock"></i> Temps plein
                    </span>
                    {% endif %}
                </div>

                <!-- Description -->
                <p class="job-description">
                    {{ offre.description|truncatewords:30 }}
                </p>

                <!-- Compétences requises -->
                <div class="skills-required">
                    <span class="skills-label">Compétences:</span>
                    <div class="skills-tags-list">
                        {% for competence in offre.get_competences_list %}
                        <span class="skill-badge">{{ competence }}</span>
                        {% endfor %}
                    </div>
                </div>

                <!-- Métadonnées -->
                <div class="job-meta">
                    <div class="meta-item">
                        <i class="fas fa-calendar-alt"></i>
                        <span>{{ offre.date_publication|date:"d M Y" }}</span>
                    </div>
                    <div class="meta-item">
                        <i class="fas fa-users"></i>
                        <span>{{ offre.candidats|length }}  candidat{{ offre.candidats|length|pluralize }}</span>
                    </div>
                    {% if offre.date_limite %}
                    <div class="meta-item deadline">
                        <i class="fas fa-clock"></i>
                        <span>{{ offre.date_limite|date:"d M Y" }}</span>
                    </div>
                    {% endif %}
                </div>

                <!-- Boutons d'action -->
                <div class="job-actions">
                    <button class="btn-favorite" title="Sauvegarder">
                        <i class="far fa-heart"></i>
                    </button>
                    <button type="button" class="btn btn-details" data-bs-toggle="modal" data-bs-target="#detailsModal{{ offre.id }}">
                        <i class="fas fa-info-circle"></i>
                        Détails
                    </button>
                    <button type="button" class="btn btn-apply" data-bs-toggle="modal" data-bs-target="#postulerModal{{ offre.id }}">
                        <i class="fas fa-paper-plane"></i>
                        Postuler
                    </button>
                </div>
            </div>

            <!-- Modal détails -->
            <div class="modal fade" id="detailsModal{{ offre.id }}" tabindex="-1" aria-labelledby="detailsModalLabel{{ offre.id }}" aria-hidden="true">
                <div class="modal-dialog modal-lg modal-dialog-scrollable">
                    <div class="modal-content modern-modal">
                        <div class="modal-header">
                            <h5 class="modal-title" id="detailsModalLabel{{ offre.id }}">
                                <i class="fas fa-briefcase"></i>
                                {{ offre.titre }}
                            </h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fermer"></button>
                        </div>
                        <div class="modal-body">
                            <div class="job-detail-item">
                                <i class="fas fa-building"></i>
                                <strong>Entreprise :</strong> {{ offre.entreprise }}
                            </div>
                            <div class="job-detail-item">
                                <i class="fas fa-map-marker-alt"></i>
                                <strong>Lieu :</strong> {{ offre.localisation }}
                            </div>
                            <div class="job-detail-item">
                                <i class="fas fa-file-contract"></i>
                                <strong>Type de contrat :</strong> {{ offre.type_contrat }}
                            </div>
                            {% if offre.salaire_min and offre.salaire_max %}
                            <div class="job-detail-item">
                                <i class="fas fa-money-bill-wave"></i>
                                <strong>Salaire :</strong> {{ offre.get_salaire_display }}
                            </div>
                            {% endif %}
                            <div class="job-detail-item">
                                <i class="fas fa-calendar-alt"></i>
                                <strong>Date de publication :</strong> {{ offre.date_publication|date:"d M Y" }}
                            </div>
                            {% if offre.date_limite %}
                            <div class="job-detail-item">
                                <i class="fas fa-clock"></i>
                                <strong>Date limite :</strong> {{ offre.date_limite|date:"d M Y" }}
                            </div>
                            {% endif %}
                            <div class="job-detail-description">
                                <h6><i class="fas fa-file-text"></i> Description complète :</h6>
                                <div class="description-content">{{ offre.description|linebreaks }}</div>
                            </div>
                            <div class="job-detail-item">
                                <h6><i class="fas fa-code"></i> Compétences requises :</h6>
                                <div class="skills-tags-list">
                                    {% for competence in offre.get_competences_list %}
                                    <span class="skill-badge">{{ competence }}</span>
                                    {% endfor %}
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                                <i class="fas fa-times"></i>
                                Fermer
                            </button>
                            <button type="button" class="btn btn-apply" data-bs-dismiss="modal" data-bs-toggle="modal" data-bs-target="#postulerModal{{ offre.id }}">
                                <i class="fas fa-paper-plane"></i>
                                Postuler maintenant
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Modal postuler -->
            <div class="modal fade" id="postulerModal{{ offre.id }}" tabindex="-1" aria-labelledby="postulerModalLabel{{ offre.id }}" aria-hidden="true">
                <div class="modal-dialog">
                    <div class="modal-content modern-modal">
                        <form method="post" action="{% url 'postuler' offre.id %}" enctype="multipart/form-data">
                            {% csrf_token %}
                            <div class="modal-header">
                                <h5 class="modal-title" id="postulerModalLabel{{ offre.id }}">
                                    <i class="fas fa-paper-plane"></i>
                                    Postuler à : {{ offre.titre }}
                                </h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fermer"></button>
                            </div>
                            <div class="modal-body">
                                <div class="upload-area">
                                    <div class="upload-icon">
                                        <i class="fas fa-cloud-upload-alt"></i>
                                    </div>
                                    <h6>Télécharger votre CV</h6>
                                    <p class="upload-info">PDF, DOCX acceptés (max 2MB)</p>
                                    <input class="form-control file-input" type="file" id="cv{{ offre.id }}" name="cv" accept=".pdf,.doc,.docx" required />
                                    <div class="file-info" style="display: none;">
                                        <i class="fas fa-file"></i>
                                        <span class="file-name"></span>
                                        <button type="button" class="remove-file"><i class="fas fa-times"></i></button>
                                    </div>
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="submit" class="btn btn-apply">
                                    <i class="fas fa-paper-plane"></i>
                                    Envoyer ma candidature
                                </button>
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                                    <i class="fas fa-times"></i>
                                    Annuler
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <div class="no-jobs-message">
            <div class="no-jobs-icon">
                <i class="fas fa-search"></i>
            </div>
            <h4>Aucune offre disponible</h4>
            <p>Revenez bientôt pour découvrir de nouvelles opportunités !</p>
        </div>
        {% endif %}
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Animation des cartes au scroll
        window.addEventListener('scroll', () => {
            const cards = document.querySelectorAll('.job-card');
            cards.forEach(card => {
                const cardTop = card.getBoundingClientRect().top;
                const cardVisible = 150;
                
                if (cardTop < window.innerHeight - cardVisible) {
                    card.style.opacity = '1';
                    card.style.transform = 'translateY(0)';
                }
            });
        });

        // Filtres
        document.querySelectorAll('.filter-chip').forEach(chip => {
            chip.addEventListener('click', function() {
                document.querySelectorAll('.filter-chip').forEach(c => c.classList.remove('active'));
                this.classList.add('active');
                
                const filter = this.getAttribute('data-filter');
                const cards = document.querySelectorAll('.job-card');
                
                cards.forEach(card => {
                    if (filter === 'all') {
                        card.style.display = 'block';
                    } else if (filter === 'urgent') {
                        const hasUrgent = card.querySelector('.badge-urgent');
                        card.style.display = hasUrgent ? 'block' : 'none';
                    } else {
                        const cardType = card.getAttribute('data-type');
                        card.style.display = cardType === filter ? 'block' : 'none';
                    }
                });
            });
        });

        // Bouton favoris
        document.querySelectorAll('.btn-favorite').forEach(btn => {
            btn.addEventListener('click', function() {
                const icon = this.querySelector('i');
                if (icon.classList.contains('far')) {
                    icon.classList.remove('far');
                    icon.classList.add('fas');
                    this.style.color = '#e53e3e';
                } else {
                    icon.classList.remove('fas');
                    icon.classList.add('far');
                    this.style.color = '';
                }
            });
        });

        // Gestion du upload de fichier
        document.querySelectorAll('.file-input').forEach(input => {
            input.addEventListener('change', function() {
                const fileInfo = this.parentElement.querySelector('.file-info');
                const fileName = this.parentElement.querySelector('.file-name');
                const uploadArea = this.parentElement;
                
                if (this.files[0]) {
                    fileName.textContent = this.files[0].name;
                    fileInfo.style.display = 'flex';
                    uploadArea.classList.add('has-file');
                } else {
                    fileInfo.style.display = 'none';
                    uploadArea.classList.remove('has-file');
                }
            });
        });

        // Supprimer le fichier sélectionné
        document.querySelectorAll('.remove-file').forEach(btn => {
            btn.addEventListener('click', function() {
                const input = this.closest('.upload-area').querySelector('.file-input');
                const fileInfo = this.closest('.upload-area').querySelector('.file-info');
                const uploadArea = this.closest('.upload-area');
                
                input.value = '';
                fileInfo.style.display = 'none';
                uploadArea.classList.remove('has-file');
            });
        });

        // Effets sur les boutons
        document.querySelectorAll('.btn').forEach(btn => {
            btn.addEventListener('click', function(e) {
                if (!this.classList.contains('btn-close')) {
                    const ripple = document.createElement('span');
                    const rect = this.getBoundingClientRect();
                    const size = Math.max(rect.width, rect.height);
                    const x = e.clientX - rect.left - size / 2;
                    const y = e.clientY - rect.top - size / 2;
                    
                    ripple.style.width = ripple.style.height = size + 'px';
                    ripple.style.left = x + 'px';
                    ripple.style.top = y + 'px';
                    ripple.classList.add('ripple');
                    
                    this.style.position = 'relative';
                    this.style.overflow = 'hidden';
                    this.appendChild(ripple);
                    
                    setTimeout(() => {
                        ripple.remove();
                    }, 600);
                }
            });
        });


        // Recherche d'offres
    document.querySelector('.search-btn-home').addEventListener('click', function() {
        performSearch();
    });

    // Recherche en appuyant sur Entrée
    document.getElementById('searchJob').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            performSearch();
        }
    });

    document.getElementById('searchLocation').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            performSearch();
        }
    });

    function performSearch() {
        const searchTerm = document.getElementById('searchJob').value.toLowerCase();
        const location = document.getElementById('searchLocation').value.toLowerCase();
        const cards = document.querySelectorAll('.job-card');

        let visibleCount = 0;

        cards.forEach(card => {
            const title = card.querySelector('.job-title').textContent.toLowerCase();
            const description = card.querySelector('.job-description').textContent.toLowerCase();
            const cardLocation = card.querySelector('.job-location').textContent.toLowerCase();
            const skills = Array.from(card.querySelectorAll('.skill-badge')).map(badge => badge.textContent.toLowerCase()).join(' ');

            // Vérifier si le terme de recherche correspond
            const matchesSearch = !searchTerm || 
                                 title.includes(searchTerm) || 
                                 description.includes(searchTerm) || 
                                 skills.includes(searchTerm);

            // Vérifier si la localisation correspond
            const matchesLocation = !location || 
                                   location === 'dakar' || 
                                   cardLocation.includes(location);

            if (matchesSearch && matchesLocation) {
                card.style.display = 'block';
                visibleCount++;
            } else {
                card.style.display = 'none';
            }
        });

        // Afficher un message si aucun résultat
        showNoResultsMessage(visibleCount);
    }

    function showNoResultsMessage(count) {
        // Supprimer l'ancien message s'il existe
        const oldMessage = document.querySelector('.no-results-message');
        if (oldMessage) oldMessage.remove();

        if (count === 0) {
            const message = document.createElement('div');
            message.className = 'no-results-message';
            message.innerHTML = `
                <div style="text-align: center; padding: 3rem; color: #718096;">
                    <i class="fas fa-search" style="font-size: 3rem; margin-bottom: 1rem; opacity: 0.5;"></i>
                    <h3>Aucune offre trouvée</h3>
                    <p>Essayez de modifier vos critères de recherche</p>
                    <button onclick="resetSearch()" style="margin-top: 1rem; padding: 0.75rem 2rem; background: linear-gradient(45deg, #667eea, #764ba2); color: white; border: none; border-radius: 10px; cursor: pointer; font-weight: 600;">
                        <i class="fas fa-redo"></i> Réinitialiser la recherche
                    </button>
                </div>
            `;
            document.querySelector('.jobs-grid').appendChild(message);
        }
    }

    function resetSearch() {
        document.getElementById('searchJob').value = '';
        document.getElementById('searchLocation').value = 'Dakar';
        document.querySelectorAll('.job-card').forEach(card => {
            card.style.display = 'block';
        });
        const message = document.querySelector('.no-results-message');
        if (message) message.remove();
        
        // Réactiver le filtre "Toutes les offres"
        document.querySelectorAll('.filter-chip').forEach(chip => chip.classList.remove('active'));
        document.querySelector('[data-filter="all"]').classList.add('active');
    }

    // Filtres par type de contrat
    document.querySelectorAll('.filter-chip').forEach(chip => {
        chip.addEventListener('click', function() {
            // Retirer la classe active de tous les filtres
            document.querySelectorAll('.filter-chip').forEach(c => c.classList.remove('active'));
            
            // Ajouter la classe active au filtre cliqué
            this.classList.add('active');
            
            const filter = this.getAttribute('data-filter');
            const cards = document.querySelectorAll('.job-card');
            
            let visibleCount = 0;

            cards.forEach(card => {
                if (filter === 'all') {
                    card.style.display = 'block';
                    visibleCount++;
                } else if (filter === 'urgent') {
                    const hasUrgent = card.querySelector('.badge-urgent');
                    if (hasUrgent) {
                        card.style.display = 'block';
                        visibleCount++;
                    } else {
                        card.style.display = 'none';
                    }
                } else {
                    // Filtrer par type de contrat
                    const typeContrat = card.getAttribute('data-type');
                    if (typeContrat === filter) {
                        card.style.display = 'block';
                        visibleCount++;
                    } else {
                        card.style.display = 'none';
                    }
                }
            });

            // Supprimer l'ancien message s'il existe
            const oldMessage = document.querySelector('.no-results-message');
            if (oldMessage) oldMessage.remove();

            // Afficher message si aucun résultat
            if (visibleCount === 0) {
                showNoResultsMessage(0);
            }
        });
    });

    // Réinitialiser les filtres au chargement
    window.addEventListener('load', function() {
        document.querySelectorAll('.job-card').forEach(card => {
            card.style.display = 'block';
        });
    });
    </script>
</body>
</html>